{{- /* Typo theme hook: injected at the end of <head>.
      We use it for:
      - Loading KaTeX CSS only when the page contains math
      - (Optional) Multilingual hreflang tags
      - (Optional) JSON-LD for posts/papers/notes
*/ -}}

{{- /* Optional: self-hosted Chinese serif (FZ Lanting Song).
      Place licensed WebFont files under:
        - static/fonts/FZLanTingSong/FZLanTingSong-Regular.woff2
        - static/fonts/FZLanTingSong/FZLanTingSong-SemiBold.woff2 (optional)
      We only inject @font-face when files exist to avoid 404s. */ -}}
{{- $fzRegular := "static/fonts/FZLanTingSong/FZLanTingSong-Regular.woff2" -}}
{{- $fzSemiBold := "static/fonts/FZLanTingSong/FZLanTingSong-SemiBold.woff2" -}}
{{- if or (fileExists $fzRegular) (fileExists $fzSemiBold) -}}
  {{- /* Only preload for Chinese pages to avoid downloading a large CJK font on /en/. */ -}}
  {{- if eq .Site.Language.Lang "zh" -}}
    {{- if fileExists $fzRegular -}}
      <link rel="preload"
            href="/fonts/FZLanTingSong/FZLanTingSong-Regular.woff2"
            as="font"
            type="font/woff2"
            crossorigin>
    {{- end -}}
    {{- if fileExists $fzSemiBold -}}
      <link rel="preload"
            href="/fonts/FZLanTingSong/FZLanTingSong-SemiBold.woff2"
            as="font"
            type="font/woff2"
            crossorigin>
    {{- end -}}
  {{- end -}}
  <style>
    {{- if fileExists $fzRegular -}}
    @font-face {
      font-family: "FZLanTingSongWeb";
      src: url("/fonts/FZLanTingSong/FZLanTingSong-Regular.woff2") format("woff2");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    {{- end -}}
    {{- if fileExists $fzSemiBold -}}
    @font-face {
      font-family: "FZLanTingSongWeb";
      src: url("/fonts/FZLanTingSong/FZLanTingSong-SemiBold.woff2") format("woff2");
      font-weight: 600;
      font-style: normal;
      font-display: swap;
    }
    {{- end -}}
  </style>
{{- end -}}

{{- $hasMath := false -}}
{{- with .Page -}}
  {{- if .Store.Get "hasMath" -}}
    {{- $hasMath = true -}}
  {{- end -}}
{{- end -}}

{{- if $hasMath -}}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/katex@0.16.28/dist/katex.min.css"
        crossorigin="anonymous">
{{- end -}}

{{- /* allow per-page robots override (e.g. noindex for /search/) */ -}}
{{- with .Params.robots -}}
  <meta name="robots" content="{{ . }}">
{{- end -}}

{{- /* hreflang (recommended for multilingual SEO) */ -}}
{{- if .IsTranslated -}}
  {{- range .AllTranslations -}}
    <link rel="alternate"
          hreflang="{{ .Language.LanguageCode | default .Language.Lang }}"
          href="{{ .Permalink }}">
  {{- end -}}
{{- end -}}

{{- /* JSON-LD (basic; adjust as needed) */ -}}
{{- $articleSections := slice "posts" "papers" "notes" "philosophy" -}}
{{- if and .IsPage (in $articleSections .Section) -}}
  {{- $desc := .Description -}}
  {{- if not $desc -}}
    {{- $desc = .Summary | plainify -}}
  {{- end -}}
  {{- $author := .Site.Params.author | default .Site.Title -}}
  {{- $schema := dict
      "@context" "https://schema.org"
      "@type" "BlogPosting"
      "headline" .Title
      "description" $desc
      "inLanguage" (.Site.Language.LanguageCode | default .Site.Language.Lang)
      "datePublished" (.Date.Format "2006-01-02T15:04:05Z07:00")
      "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")
      "url" .Permalink
      "mainEntityOfPage" (dict "@type" "WebPage" "@id" .Permalink)
      "author" (dict "@type" "Person" "name" $author)
      "publisher" (dict "@type" "Person" "name" $author)
    -}}
  <script type="application/ld+json">{{ $schema | jsonify }}</script>
{{- end -}}
